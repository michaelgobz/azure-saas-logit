
### Welcome ###
Welcome to the Azure SaaS Dev Kit - Azure B2C Identity Provider deployment script.

### Preparing ###
Working in directory /asdk/src/Saas.Identity/Saas.IdentityProvider/deployment.

### Sudo ###
Please log in with sudo to run this script.

### Checking prerequisites ###
Checking prerequisites...

### Checking OS ###
Supported operating system: linux

### Checking Repo forked ###
Forked repository true: michaelgobz/azure-saas-logit

### Checking bash version ###
Pass: '5.1.16(1)-release > 5.0.0'

### Checking az cli version ###
Pass: '2.48.1 > 2.46.0'

### Checking jq version ###
Pass: '1.6 > 1.5'

### Configation Settings ###
Initializing Configuration

### Backup Configuration ###
Backing up existing configuration file to: /asdk/src/Saas.Identity/Saas.IdentityProvider/deployment/log/2023-05-21--13-23-59/config.begin.json
# Configuration settings: /asdk/src/Saas.Identity/Saas.IdentityProvider/deployment/config/config.json.

### Postfix ###
Using existing postfix to continue or patch existing deployment: r6e7

### Configuration Validation ###
Validating Initial Configuration Settings...
# All required initial configuration settings exist.

### Login to Azure ###
Log into you Azure tenant
# Setting account subscription to d8d41247-cc7c-4efc-a0c6-335561c60f8b.
# 
# You are logged in to tenant: 64672ee1-084a-4ef8-acd6-ffe55046ded9.
# User context for 'asdk-usr-b2c-r6e7' have been created.
# User context for 'asdk-usr-sp-r6e7' have been created.

### Attention. ###
Please don't go anywhere just yet. You may need to log into the Azure B2C tenant in a few minutes. Thank you.

### Resource Group ###
Provisioning resource group rg-asdk-test-r6e7...
# Resource group rg-asdk-test-r6e7 provision complete.
# Checking if storage account stasdktestr6e7 exists...

### Key Vault ###
Provisioning Key Vault...
# Checking if the Key Vault have already been successfully created...
# Existing Key Vault found.

### Key Vault Certificates and Secrets ###
Getting and/or creating app certificates and secrets...
# A self-signing certificate for cert-signupadmin-app already exist and will be used.
# Downloading self-signing public key certificate for cert-signupadmin-app...
# A self-signing certificate for cert-saas-app already exist and will be used.
# Downloading self-signing public key certificate for cert-saas-app...
# A self-signing certificate for cert-permissions-api already exist and will be used.
# Downloading self-signing public key certificate for cert-permissions-api...
# Downloading secret for RestApiKey...
# Key Vault Certificats and Secrets Completed Successfully

### Azure B2C Tenant ###
Provisioning Azure B2C...
# Existing Azure B2C tenant found and will be used.

### Azure B2C Tenant Login ###
Logging into B2C tenant asdktestr6e7.onmicrosoft.com.
# You are already logged in to the Azure B2C tenant: asdktestr6e7.onmicrosoft.com
# Azure B2C tenant login successful.

### Azure B2C App Registrations ###
Adding app registrations to Azure B2C tenant.

### Azure B2C Instance ###
Setting instance asdktestr6e7.b2clogin.com

### admin-api ###
Provisioning app registration for: admin-api...
# App registration for admin-api already exist. If you made changes or updated the certificate, you will have to delete the app registration to use this script to update it. 

### signupadmin-app ###
Provisioning app registration for: signupadmin-app...
# App registration for signupadmin-app already exist. If you made changes or updated the certificate, you will have to delete the app registration to use this script to update it. 

### saas-app ###
Provisioning app registration for: saas-app...
# App registration for saas-app already exist. If you made changes or updated the certificate, you will have to delete the app registration to use this script to update it. 

### permissions-api ###
Provisioning app registration for: permissions-api...
# App registration for permissions-api already exist. If you made changes or updated the certificate, you will have to delete the app registration to use this script to update it. 

### IdentityExperienceFramework ###
Provisioning app registration for: IdentityExperienceFramework...
# App registration for IdentityExperienceFramework already exist. If you made changes or updated the certificate, you will have to delete the app registration to use this script to update it. 

### ProxyIdentityExperienceFramework ###
Provisioning app registration for: ProxyIdentityExperienceFramework...
# App registration for ProxyIdentityExperienceFramework already exist. If you made changes or updated the certificate, you will have to delete the app registration to use this script to update it. 
# Azure B2C app registrations have completed.
# Adding secrets to KeyVault
# Secret for signupadmin-app is empty. If the secret have already been defined then this is to be expected.
# Secret for saas-app is empty. If the secret have already been defined then this is to be expected.

### Provisioning Service Principal for Policy Key Creation ###
Provisioning or updating service principal for policy key creation: asdk-usr-sp-r6e7
# Service principal for policy key configuration already exist. Fetching details...
# Service principal id: fc89c178-4f49-498f-93a0-412474e20d4f
# Setting service principal permissions TrustFrameworkKeySet.ReadWrite.All, Policy.ReadWrite.TrustFramework
# Permission '4a771c9a-1cf2-4609-b88e-3d3e02d539cd' already assigned to service principal.
# Permission TrustFrameworkKeySet.ReadWrite.All set.
# Permission '79a677f7-b79d-40d0-a36a-3e6f8688dd7a' already assigned to service principal.
# Permission Policy.ReadWrite.TrustFramework set.
# Resetting service principal credentials...
# Service principal created or updated successfully. Waiting 60 seconds for letting it propagate...
# Service principal update/creation completed.

### Service Principal Login ###
Logging in with service principal...
# Running the B2C Policy Script script in the context of the user asdk-usr-sp-r6e7 to allow a seperate az cli login session with the B2C tenant.
# Service principal login successful.

### Policy Keys ###
Provisioning Policy Keys
# Policy key TokenSigningKeyContainer already exist.
# Policy key TokenEncryptionKeyContainer already exist.
# Policy key RestApiKey already exist.
# B2C policy configuration script has completed.

### Generating Identity Foundation services parameters... ###

# Provisioning 'IdentityFoundationDeployment' to resource group rg-asdk-test-r6e7...
# 

### Critical Error ###
Failed to deploy Identity Foundation services

### Critical error ###
Deployment of Identity Provider failed.

### Configuration Validation ###
Validating Initial Configuration Settings...
# All required initial configuration settings exist.

### Cleaning up ###
Starting cleaning up...
# Deleting locally stored service principal credentials.
# Deleting service principal credentials using user 'asdk-usr-b2c-r6e7'
# Deleting service principal credentials for 32d93cdb-70b8-4e75-bb6d-cd908d94a3ed.
# Deleting service principal credentials with keyId: 854b82bf-e5bd-43cf-9ee3-767860599238 for fc89c178-4f49-498f-93a0-412474e20d4f...
# 
# Service principal credentials have been removed locally and in Azure AD.
# User context for asdk-usr-sp-r6e7 have been deleted.
# User context for asdk-usr-b2c-r6e7 have been deleted.
# Clean up has completed.
